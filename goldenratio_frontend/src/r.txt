import React, { useState } from "react";
import { Link, useNavigate } from "react-router-dom";
import * as Yup from 'yup';
import request, { gql } from 'graphql-request';
import BASEURL from "./URLs/BaseURL";
import { useFormik } from 'formik';

const loginSchema = Yup.object().shape({
  email: Yup.string()
    .email('Invalid email format')
    .min(3, 'Minimum 3 characters')
    .max(50, 'Maximum 50 characters')
    .required('Email is required'),
  password: Yup.string()
    .min(3, 'Minimum 3 characters')
    .max(50, 'Maximum 50 characters')
    .required('Password is required'),
});

const LOGIN = gql`
  mutation Login($email: String!, $password: String!) {
    tokenAuth(email: $email, password: $password) {
      success
      errors
      token
      user {
        id
        username    
        isActive
      }
    }
  }
`;

const Login = () => {
  const [loading, setLoading] = useState(false);
  const navigate = useNavigate();

  const formik = useFormik({
    initialValues: {
      email: '',
      password: '',
    },
    validationSchema: loginSchema,
    onSubmit: async (values, { setStatus, setSubmitting }) => {
      setLoading(true);
      try {
        const response: any = await request(BASEURL, LOGIN, {
          email: values.email,
          password: values.password,
        });

        if (response.tokenAuth.success) {
          localStorage.setItem('goldenratio', JSON.stringify(response));
          navigate('/home');
        } else {
          setStatus('Invalid login credentials');
          setSubmitting(false);
        }
      } catch (error) {
        console.error('Login error:', error);
        setStatus('Login failed. Please try again.');
      } finally {
        setLoading(false);
      }
    },
  });

  return (
    <div className="text-white h-[100vh] flex justify-center items-center bg-cover" style={{ backgroundImage: `url(${'assets/make-up.jpg'})` }}>
      <div className="absolute top-5 left-5 p-8">
        <h1 className="text-left">
          <span className="font-serif text-6xl text-blue-600">Aureus</span>{' '}
          <span className="font-serif text-6xl text-yellow-600">Lens</span><br />
          <span className="ml-56 font-serif text-2xl text-blue-600">by</span>{' '}
          <span className="ml-2 font-serif text-2xl text-yellow-600">Vividobots</span>
        </h1>
      </div>

      <div className="bg-slate-800 border border-slate-600 rounded-md p-8 shadow-lg backdrop-filter backdrop-blur-lg bg-opacity-30 relative transition-all duration-200">
        <h1 className="text-4xl text-white font-bold text-center mb-6">Login</h1>
        <form onSubmit={formik.handleSubmit}>
          <div className="relative my-4">
            <input
              type="text"
              id="email"
              className="block w-72 py-2.5 px-0 text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:text-white focus:border-blue-600 peer"
              placeholder=" "
              {...formik.getFieldProps('email')}
            />
            <label
              htmlFor="email"
              className="absolute text-sm text-white duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus left-0 peer-focus:text-blue-600 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6"
            >
              Email
            </label>
            {formik.touched.email && formik.errors.email ? (
              <span className="text-red-500 text-sm">{formik.errors.email}</span>
            ) : null}
          </div>

          <div className="relative my-4">
            <input
              type="password"
              id="password"
              className="block w-72 py-2.5 px-0 text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:text-white focus:border-blue-600 peer"
              placeholder=" "
              {...formik.getFieldProps('password')}
            />
            <label
              htmlFor="password"
              className="absolute text-sm text-white duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-blue-600 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6"
            >
              Password
            </label>
            {/* {formik.touched.password && formik.errors.password ? (
              <span className="text-red-500 text-sm">{formik.errors.password}</span>
            ) : null} */}
          </div>

          {formik.status && (
            <div className="text-red-500 text-sm">{formik.status}</div>
          )}

          <div className="form-group">
            {loading ? (
              <div className="text-center">
                <div className="spinner-border text-primary" role="status">
                  <span className="sr-only">Loading...</span>
                </div>
              </div>
            ) : null}
          </div>

          <div className="clearfix"></div>

          <button
            className="w-full mb-4 text-[18px] mt-6 rounded-full bg-blue-600 hover:bg-blue-700 text-white py-2 transition-colors duration-300"
            type="submit"
            disabled={loading || !formik.isValid || formik.isSubmitting}
          >
            Login
          </button>

          <div>
            <span className="m-4">New Here? <Link className="text-blue-500" to='/register'>Create an Account</Link></span>
          </div>
        </form>
      </div>
    </div>
  );
};

export default Login;

